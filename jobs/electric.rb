masala = [
  { date: Date.strptime("12/1/2012", "%m/%d/%Y"), energy:1260, cost:128.00 },
  { date: Date.strptime("1/1/2013", "%m/%d/%Y"), energy:1081, cost:112.71 },
  { date: Date.strptime("2/1/2013", "%m/%d/%Y"), energy:1666, cost:169.40 },
  { date: Date.strptime("3/1/2013", "%m/%d/%Y"), energy:794, cost:84.78 },
  { date: Date.strptime("4/1/2013", "%m/%d/%Y"), energy:802, cost:85.24 },
  { date: Date.strptime("5/1/2013", "%m/%d/%Y"), energy:508, cost:57.01 },
  { date: Date.strptime("6/1/2013", "%m/%d/%Y"), energy:466, cost:52.77 },
  { date: Date.strptime("7/11/2013", "%m/%d/%Y"), energy:585, cost:68.29 },
  { date: Date.strptime("8/1/2013", "%m/%d/%Y"), energy:742, cost:91.41 },
  { date: Date.strptime("9/1/2013", "%m/%d/%Y"), energy:711, cost:84.20 },
  { date: Date.strptime("10/1/2013", "%m/%d/%Y"), energy:919, cost:98.11 },
  { date: Date.strptime("11/1/2013", "%m/%d/%Y"), energy:960, cost:102.11 },
  { date: Date.strptime("12/1/2013", "%m/%d/%Y"), energy:908, cost:97.30 },
  { date: Date.strptime("1/1/2014", "%m/%d/%Y"), energy:928, cost:99.93 },
  { date: Date.strptime("2/1/2014", "%m/%d/%Y"), energy:812, cost:88.44 },
  { date: Date.strptime("3/1/2014", "%m/%d/%Y"), energy:672, cost:75.61 },
  { date: Date.strptime("4/1/2014", "%m/%d/%Y"), energy:542, cost:64.36 },
  { date: Date.strptime("5/1/2014", "%m/%d/%Y"), energy:637, cost:76.26 },
  { date: Date.strptime("6/1/2014", "%m/%d/%Y"), energy:566, cost:69.96 },
  { date: Date.strptime("7/1/2014", "%m/%d/%Y"), energy:722, cost:92.70 },
  { date: Date.strptime("8/1/2014", "%m/%d/%Y"), energy:765, cost:97.92 },
  { date: Date.strptime("9/1/2014", "%m/%d/%Y"), energy:675, cost:81.89 },
  { date: Date.strptime("10/1/2014", "%m/%d/%Y"), energy:756, cost:82.27 },
  { date: Date.strptime("11/1/2014", "%m/%d/%Y"), energy:1264, cost:132.25 },
  { date: Date.strptime("12/1/2014", "%m/%d/%Y"), energy:1511, cost:156.30 },
  { date: Date.strptime("1/1/2015", "%m/%d/%Y"), energy:852, cost:91.23 },
  { date: Date.strptime("2/1/2015", "%m/%d/%Y"), energy:831, cost:90.51 },
  { date: Date.strptime("3/1/2015", "%m/%d/%Y"), energy:432, cost:50.73 },
  { date: Date.strptime("4/1/2015", "%m/%d/%Y"), energy:561, cost:63.41 },
  { date: Date.strptime("5/1/2015", "%m/%d/%Y"), energy:-81, cost:7.64 },
  { date: Date.strptime("6/1/2015", "%m/%d/%Y"), energy:-160, cost:7.64 },
  { date: Date.strptime("7/1/2015", "%m/%d/%Y"), energy:-153, cost:7.61 },
  { date: Date.strptime("8/1/2015", "%m/%d/%Y"), energy:71, cost:7.52 },
  { date: Date.strptime("9/1/2015", "%m/%d/%Y"), energy:475, cost:21.75 },
  { date: Date.strptime("10/1/2015", "%m/%d/%Y"), energy:577, cost:63.40 }
]

ostara = [
  { date: Date.strptime("11/1/2013", "%m/%d/%Y"), energy:2728, cost:258.26 },
  { date: Date.strptime("12/1/2013", "%m/%d/%Y"), energy:2747, cost:260.64 },
  { date: Date.strptime("1/1/2014", "%m/%d/%Y"), energy:2631, cost:251.66 },
  { date: Date.strptime("2/1/2014", "%m/%d/%Y"), energy:2463, cost:236.40 },
  { date: Date.strptime("3/1/2014", "%m/%d/%Y"), energy:2480, cost:242.13 },
  { date: Date.strptime("4/1/2014", "%m/%d/%Y"), energy:2381, cost:240.63 },
  { date: Date.strptime("5/1/2014", "%m/%d/%Y"), energy:2656, cost:291.98 },
  { date: Date.strptime("6/1/2014", "%m/%d/%Y"), energy:2581, cost:335.64 },
  { date: Date.strptime("7/1/2014", "%m/%d/%Y"), energy:2331, cost:299.36 },
  { date: Date.strptime("8/1/2014", "%m/%d/%Y"), energy:2779, cost:349.77 },
  { date: Date.strptime("9/1/2014", "%m/%d/%Y"), energy:2514, cost:296.09 },
  { date: Date.strptime("10/1/2014", "%m/%d/%Y"), energy:2414, cost:230.65 }
]

chrysalis = [
  { date: Date.strptime("8/1/2011", "%m/%d/%Y"), energy:193, cost:29.85 },
  { date: Date.strptime("9/1/2011", "%m/%d/%Y"), energy:335, cost:46.55 },
  { date: Date.strptime("10/1/2011", "%m/%d/%Y"), energy:455, cost:60.17 },
  { date: Date.strptime("11/1/2011", "%m/%d/%Y"), energy:1468, cost:178.87 },
  { date: Date.strptime("12/1/2011", "%m/%d/%Y"), energy:1176, cost:142.03 },
  { date: Date.strptime("1/1/2012", "%m/%d/%Y"), energy:793, cost:94.34 },
  { date: Date.strptime("2/1/2012", "%m/%d/%Y"), energy:429, cost:54.18 },
  { date: Date.strptime("3/1/2012", "%m/%d/%Y"), energy:35, cost:10.73 },
  { date: Date.strptime("4/1/2012", "%m/%d/%Y"), energy:-51, cost:7.18 },
  { date: Date.strptime("5/1/2012", "%m/%d/%Y"), energy:-109, cost:7.85 },
  { date: Date.strptime("6/1/2012", "%m/%d/%Y"), energy:-134, cost:7.85 },
  { date: Date.strptime("7/1/2012", "%m/%d/%Y"), energy:18, cost:7.85 },
  { date: Date.strptime("8/1/2012", "%m/%d/%Y"), energy:100, cost:7.85 },
  { date: Date.strptime("9/1/2012", "%m/%d/%Y"), energy:160, cost:7.85 },
  { date: Date.strptime("10/1/2012", "%m/%d/%Y"), energy:405, cost:53.29 },
  { date: Date.strptime("11/1/2012", "%m/%d/%Y"), energy:446, cost:59.93 },
  { date: Date.strptime("12/1/2012", "%m/%d/%Y"), energy:879, cost:111.09 },
  { date: Date.strptime("1/1/2013", "%m/%d/%Y"), energy:632, cost:83.11 },
  { date: Date.strptime("2/1/2013", "%m/%d/%Y"), energy:662, cost:86.67 },
  { date: Date.strptime("3/1/2013", "%m/%d/%Y"), energy:401, cost:55.56 },
  { date: Date.strptime("4/1/2013", "%m/%d/%Y"), energy:476, cost:64.32 },
  { date: Date.strptime("5/1/2013", "%m/%d/%Y"), energy:-52, cost:7.93 },
  { date: Date.strptime("6/1/2013", "%m/%d/%Y"), energy:-5, cost:7.92 },
  { date: Date.strptime("8/1/2013", "%m/%d/%Y"), energy:335, cost:47.36 },
  { date: Date.strptime("9/1/2013", "%m/%d/%Y"), energy:442, cost:60.25 },
  { date: Date.strptime("10/1/2013", "%m/%d/%Y"), energy:919, cost:118.35 },
  { date: Date.strptime("11/1/2013", "%m/%d/%Y"), energy:806, cost:104.76 },
  { date: Date.strptime("12/1/2013", "%m/%d/%Y"), energy:1138, cost:144.96 },
  { date: Date.strptime("1/1/2014", "%m/%d/%Y"), energy:1125, cost:144.22 },
  { date: Date.strptime("2/1/2014", "%m/%d/%Y"), energy:708, cost:93.73 },
  { date: Date.strptime("3/1/2014", "%m/%d/%Y"), energy:323, cost:47.65 },
  { date: Date.strptime("4/1/2014", "%m/%d/%Y"), energy:130, cost:24.40 },
  { date: Date.strptime("5/1/2014", "%m/%d/%Y"), energy:276, cost:42.79 },
  { date: Date.strptime("6/1/2014", "%m/%d/%Y"), energy:13, cost:9.65 },
  { date: Date.strptime("7/1/2014", "%m/%d/%Y"), energy:172, cost:29.18 },
  { date: Date.strptime("8/1/2014", "%m/%d/%Y"), energy:222, cost:34.93 },
  { date: Date.strptime("9/1/2014", "%m/%d/%Y"), energy:180, cost:29.73 },
  { date: Date.strptime("10/1/2014", "%m/%d/%Y"), energy:323, cost:46.74 }
]

def formatEnergy(arry, residents)
  arry.map{ |m| { x: m[:date].to_time.to_i, y: m[:energy]/residents } }
end

def send_last_electric(id, arry, count)
  current = arry.max{|a,b| a[:date] <=> b[:date]}
  last = arry.select{|a| a[:date].month == current[:date].month && a[:date].year == current[:date].prev_year.year }
  dt = current[:date].strftime("%B") + ' ' + current[:date].year.to_s
  d = { current: current[:energy]/count, moreinfo: "kWh/housemate", dataDate:dt }
  d[:last] = last.first[:energy]/count unless last.empty?
  send_event( id, d)
end

SCHEDULER.every "1d", first_in: 0 do |job|
  series = [
    {
      name: "Masala",
      data: formatEnergy(masala, 12)
    },
    {
      name: "Ostara",
      data: formatEnergy(ostara, 26)
    },
    {
      name: "Chrysalis",
      data: formatEnergy(chrysalis, 16)
    }
  ]
  send_event('electric', series: series  )
  send_last_electric('masala-avg-electric', masala, 12)
  send_last_electric('chrysalis-avg-electric', chrysalis, 16)
  send_last_electric('ostara-avg-electric', ostara, 26)
end
